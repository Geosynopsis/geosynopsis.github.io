I"F<h3 id="hosting-local-registry">Hosting local registry</h3>
<p>It is fairly easy to host a docker registry locally. All we need to do is pull the docker image of registry and 
host them.</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -p 5000:5000 --name localregistry registry:2
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>If we want to save the registry images at certain location, we can as well mount the directory as following:</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -p 5000:5000 --name localregistry -v /path/to/dir:/var/lib/registry registry:2
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>The registry should be available at http://localhost:5000.</p>

<h3 id="tagging-pushing-and-pulling-image">Tagging, pushing and pulling image</h3>

<p>We can tell docker to use the locally hosted registry by tagging image.</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull nginx  # pulls image from the docker registry
docker tag nginx localhost:5000/nginx   # Tags the nginx image to use registry localhost:5000
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>Now, we can push and pull the image from local registry with following commands.</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push localhost:5000/nginx  # pushes the tagged image to the registry
docker pull localhost:5000/nginx   # pulls the image from the local registry
</code></pre></div></div>

<p>{% endhighlight %}</p>

<h3 id="local-registry-behind-nginx">Local registry behind Nginx</h3>
<p>If we want to share the registry in an internal network, we can do so by opening the firewall for port 5000 for the 
given internal network. If the internal ip of the registry host is 10.100.0.1, we can tag push and pull in following 
way:</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag nginx 10.100.0.1:5000/nginx # Tags the nginx image to use registry 10.100.0.1:5000
docker push 10.100.0.1:5000/nginx  # Pushes the tagged image to the registry
docker pull 10.100.0.1:5000/nginx   # Pulls the image from the local registry
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>If we have an internal domain controller running, it is advised to use a web server to expose the registry as 
service with internal domain name. This way, if we, at anytime, decide to migrate the registry to different computer, 
image tags doesn’t need to be changed to match the ip of the registry host. And we can also secure other port than 80
which is used for exposing web services. I generally use Nginx to do that, however one can use any web server that 
supports reverse proxy.</p>

<p>Let’s imagine, the internal domain that is pointing towards the server is registry.example.internal. The Nginx 
configuration looks as follows:</p>

<p>{% highlight python %}
    # default.conf
    server {
        listen       80;</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    server_name  registry.example.internal;
    client_max_body_size 10G;  # You might have to change this to accomodate the maximum size of image you expect
     to push.

    location / {
        proxy_pass http://10.100.0.1:5000;
    }
}
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>Now, if we run nginx with given configuration, the registry should be available at http://registry.example.internal 
and images can be tagged, pushed and pulled as follows:</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag nginx registry.example.internal/nginx # Tags the nginx image to use registry 10.100.0.1:5000
docker push registry.example.internal/nginx  # Pushes the tagged image to the registry
docker pull registry.example.internal/nginx  # Pulls the image from the local registry
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>This is, in fact, the same procedure if we want to make registry available for entire internet as well. 
Only difference in that case is that we need to open the firewall for entire internet.</p>

<h3 id="case-of-insecure-registry">Case of insecure registry</h3>
<p>Essentially, it is not advised to use the insecure registry with docker and docker by itself doesn’t entertain 
insecure registry. But if it is only for internal/developmental purpose, one might not want to go through all the 
hassle to make the registry to communicate through https. In such a case, we can make docker to use insecure 
registry with following command:</p>

<p>{% highlight python %}</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dockerd --insecure-registry=registry.example.internal
</code></pre></div></div>

<p>{% endhighlight %}</p>

<p>Or we can edit /etc/docker/daemon.json to accomodate the insecure registry</p>

<p>{% highlight python %}
    # /etc/docker/daemon.json
    {
     …
     “insecure-registries”: [“registry.example.internal”]
    }</p>

<p>{% endhighlight %}</p>

<p><strong>Case with Kubernetes</strong></p>

<p>We have seen time and often a question appearing, how we can allow Kubernetes to use insecure registry. If Kubernetes
 is using the docker conainer platform, there is no especial settings you need to change for it to use the insecure 
 registry except the change in /etc/docker/daemon.json.</p>
:ET